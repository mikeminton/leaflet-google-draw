<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <title>Leaflet + Google (async) + Drawing — SY3 0NS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Fullscreen -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css">
  <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>

  <!-- Leaflet.Geoman (drawing/editing) -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css">
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js"></script>

  <!-- GoogleMutant (Leaflet grid layer for Google) -->
  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@0.15.0/dist/Leaflet.GoogleMutant.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Load Google Maps JS the official way (no callback file, no loader lib) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdHcFCZWzjEOj98oEn5AfufQMR0p9VgLA&v=weekly&loading=async"></script>

<script type="module">
  // ---- Config ----
  const centre = [52.677027, -2.773167]; // 29 Green Lane, SY3 0NS

  // ---- Fallback basemaps (no key) ----
  const esriImagery = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20, attribution: "Imagery © Esri" }
  );
  const esriLabels = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20, attribution: "Labels © Esri" }
  );
  const osmStreets = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 20, attribution: "© OpenStreetMap contributors" }
  );

  // ---- Build Leaflet map immediately with fallback; swap to Google when ready ----
  const map = L.map("map", {
    center: centre,
    zoom: 19,
    layers: [esriImagery, esriLabels], // temporary "hybrid" until Google is ready
    fullscreenControl: true
  });

  L.marker(centre).addTo(map).bindPopup("29 Green Lane, SY3 0NS").openPopup();

  // Minimal waiter for Google’s async loader
  async function ensureGoogle() {
    // Wait until google & importLibrary exist
    for (let i = 0; i < 400; i++) {
      if (window.google && google.maps && typeof google.maps.importLibrary === "function") break;
      await new Promise(r => setTimeout(r, 25));
    }
    // Load the 'maps' library (required for Mutant to be happy)
    if (google?.maps?.importLibrary) {
      await google.maps.importLibrary("maps");
    } else {
      throw new Error("Google Maps JS API failed to initialize (check referrer restrictions).");
    }
  }

  try {
    await ensureGoogle();

    // Create Google base layers with GoogleMutant
    const gRoad   = L.gridLayer.googleMutant({ type: "roadmap",   maxZoom: 21 });
    const gHybrid = L.gridLayer.googleMutant({ type: "hybrid",    maxZoom: 21 });
    const gSat    = L.gridLayer.googleMutant({ type: "satellite", maxZoom: 21 });

    // Switch to Google Hybrid
    map.addLayer(gHybrid);

    // Layer control (Google + fallbacks)
    const baseMaps = {
      "Google Roadmap": gRoad,
      "Google Hybrid":  gHybrid,
      "Google Satellite": gSat,
      "Esri Satellite (fallback)": esriImagery,
      "OSM Streets (fallback)": osmStreets
    };
    const overlays = { "Esri Labels (for Esri Hybrid)": esriLabels };
    L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

  } catch (err) {
    console.error(err);
    // Stay on Esri/OSM and show controls
    L.control.layers(
      { "Esri Satellite": esriImagery, "OSM Streets": osmStreets },
      { "Esri Labels (Hybrid)": esriLabels },
      { collapsed: false }
    ).addTo(map);
  }

  // ---- Drawing controls (Leaflet.Geoman) ----
  map.pm.addControls({
    position: "topleft",
    drawMarker: true,
    drawPolyline: true,
    drawRectangle: true,
    drawPolygon: true,
    drawCircle: true,
    drawCircleMarker: true,
    editMode: true,
    dragMode: true,
    cutPolygon: true,
    removalMode: true
  });

  map.on("pm:create", e => {
    if (e.layer.setStyle) e.layer.setStyle({ color: "#00AEEF", weight: 2, fillOpacity: 0.18 });
    console.log("Created feature:", e.layer.toGeoJSON());
  });

  map.on("enterFullscreen", () => map.setView(centre, 19));
</script>

<noscript>Enable JavaScript to view the map.</noscript>
</body>
</html>
