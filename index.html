<!-- Remove the old callback-based script tag -->

<!-- Use the official JS API Loader (module) -->
<script type="module">
  import { Loader } from "https://unpkg.com/@googlemaps/js-api-loader@1.16.8/dist/index.min.js";

  const API_KEY = "AIzaSyAdHcFCZWzjEOj98oEn5AfufQMR0p9VgLA"; // your key
  const centre = [52.677027, -2.773167]; // 29 Green Lane

  // Fallback layers (no key)
  const esriImagery = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20, attribution: "Imagery © Esri" }
  );
  const esriLabels = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 20, attribution: "Labels © Esri" }
  );
  const osmStreets = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom: 20, attribution: "© OpenStreetMap contributors" }
  );

  // Load Google Maps JS API the recommended way
  const loader = new Loader({
    apiKey: API_KEY,
    version: "weekly",
    // Add your preferred options here, e.g. language/region
  });

  // Wait for Google to be ready, then build the map/layers
  await loader.importLibrary("maps");

  // Now 'google' is available globally for GoogleMutant
  const gRoad   = L.gridLayer.googleMutant({ type: "roadmap",   maxZoom: 21 });
  const gHybrid = L.gridLayer.googleMutant({ type: "hybrid",    maxZoom: 21 });
  const gSat    = L.gridLayer.googleMutant({ type: "satellite", maxZoom: 21 });

  const map = L.map("map", {
    center: centre,
    zoom: 19,
    layers: [gHybrid], // start with Google Hybrid
    fullscreenControl: true
  });

  L.marker(centre).addTo(map).bindPopup("29 Green Lane, SY3 0NS").openPopup();

  const baseMaps = {
    "Google Roadmap": gRoad,
    "Google Hybrid": gHybrid,
    "Google Satellite": gSat,
    "Esri Satellite (fallback)": esriImagery,
    "OSM Streets (fallback)": osmStreets
  };
  const overlays = {
    "Esri Labels (for Esri Hybrid)": esriLabels
  };

  L.control.layers(baseMaps, overlays, { collapsed: false }).addTo(map);

  // Geoman drawing controls (keep whatever you had before)
  map.pm.addControls({
    position: "topleft",
    drawMarker: true,
    drawPolyline: true,
    drawRectangle: true,
    drawPolygon: true,
    drawCircle: true,
    drawCircleMarker: true,
    editMode: true,
    dragMode: true,
    cutPolygon: true,
    removalMode: true
  });

  map.on("pm:create", e => {
    if (e.layer.setStyle) e.layer.setStyle({ color: "#00AEEF", weight: 2, fillOpacity: 0.18 });
    console.log("Created feature:", e.layer.toGeoJSON());
  });

  map.on("enterFullscreen", () => map.setView(centre, 19));
</script>
